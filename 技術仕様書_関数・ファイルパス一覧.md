# 技術仕様書_関数・ファイルパス一覧

## 📂 プロジェクト構造

```
Tag-Manager-Nightly/
├── data/                           # データベースファイル
│   └── tags.db                     # メインデータベース
├── backup/                         # バックアップファイル
│   ├── 2025-07-25/                 # 2025年7月25日のバックアップ
│   ├── 2025-07-27/                 # 2025年7月27日のバックアップ
│   └── test/                       # テスト用バックアップ
├── resources/                      # リソースファイル
│   └── config/                     # 設定ファイル
├── modules/                        # モジュールファイル
├── tests/                          # テストファイル
├── logs/                           # ログファイル
├── archive/                        # アーカイブファイル
└── main.py                         # メインファイル
```

## 🎯 TagManagerApp クラス（主要メソッド）

### UI構築・イベント処理
- `__init__(root, db_file)` - 初期化
- `setup_ui()` - UI構築
- `load_categories()` - カテゴリ読み込み
- `refresh_tabs()` - タブ更新
- `on_category_select(event)` - カテゴリ選択
- `on_tree_select(event)` - タグ選択

### タグ管理機能
- `add_to_output(event)` - タグ追加
- `copy_to_clipboard()` - クリップボードコピー
- `toggle_favorite()` - お気に入り切り替え
- `delete_tag()` - タグ削除
- `bulk_category_change()` - 一括カテゴリ変更

### 高度な機能
- `auto_assign_uncategorized_tags()` - **AI予測統合版カテゴリ自動割り当て**
- `show_detailed_assignment_results()` - **AI予測統合版詳細結果表示**

### 新機能（AI予測・カスタマイズ）
- `show_ai_prediction_dialog()` - **AI予測機能ダイアログ**
- `show_ai_settings_dialog()` - **AI予測設定ダイアログ**
- `show_custom_keywords_dialog()` - **カスタムキーワード管理ダイアログ**
- `show_custom_rules_dialog()` - **カスタムルール管理ダイアログ**

### インポート・エクスポート
- `import_tags_async()` - 非同期インポート
- `export_all_tags()` - 全タグエクスポート
- `worker_import_tags(file_path)` - インポート処理
- `worker_import_tags_csv(file_path)` - CSVインポート

### ユーティリティ
- `filter_tags_optimized()` - 最適化フィルタ
- `sort_prompt_by_priority()` - 優先度ソート
- `apply_theme(theme_name)` - テーマ適用

## 6. 基本設定（modules/config.py）

### 定数
- `POSITIVE_PROMPT_FILE` - ポジティブプロンプトファイル
- `NEGATIVE_PROMPT_FILE` - ネガティブプロンプトファイル
- `DB_FILE` - データベースファイル（`data/tags.db`）
- `THEME_FILE` - テーマ設定ファイル（`resources/config/theme_settings.json`）
- `CATEGORY_KEYWORDS_FILE` - カテゴリキーワードファイル（`resources/config/category_keywords.json`）
- `CATEGORY_DESCRIPTIONS_FILE` - カテゴリ説明ファイル（`resources/config/category_descriptions.json`）
- `BACKUP_DIR` - バックアップディレクトリ（`backup`）
- `LOG_DIR` - ログディレクトリ（`logs`）
- `TEST_DB_FILE` - テスト用データベースファイル（`backup/test/test_tags.db`）
- `TRANSLATING_PLACEHOLDER` - 翻訳中プレースホルダー

### 設定
- `LOGGING_CONFIG` - ログ設定
- `DATABASE_CONFIG` - データベース設定
- `UI_CONFIG` - UI設定
- `DEFAULT_CATEGORIES` - デフォルトカテゴリ
- `SUPPORTED_FORMATS` - サポート形式

## 7. カテゴリ管理（modules/category_manager.py）

### 定数
- `CATEGORY_PRIORITIES` - カテゴリ優先度
- `KEYWORD_WEIGHTS` - キーワード重み

### 関数
- `load_category_keywords()` - カテゴリキーワード読み込み（一般的すぎる単語フィルタリング付き）
- `save_category_keywords(keywords)` - カテゴリキーワード保存
- `get_category_priority(category)` - カテゴリ優先度取得
- `calculate_keyword_score(tag, keyword)` - キーワードスコア計算（一般的すぎる単語除外）
- `add_category_keyword(category, keyword)` - カテゴリキーワード追加（一般的すぎる単語拒否）
- `get_category_keywords(category)` - カテゴリキーワード取得（一般的すぎる単語フィルタリング付き）
- `get_all_categories()` - 全カテゴリ取得
- `is_valid_category(category)` - カテゴリ有効性チェック
- `calculate_keyword_score(tag, keyword)` - キーワードスコア計算

## 8. コンテキスト分析（modules/context_analyzer.py）

### 定数
- `SYNONYM_MAPPING` - 同義語マッピング
- `CONTEXT_BOOST_RULES` - コンテキスト強化ルール
- `NEGATION_WORDS` - 否定語
- `MODIFIER_WORDS` - 修飾語

### 関数
- `analyze_tag_context(tag)` - タグコンテキスト分析（一般的すぎる単語除外）
- `calculate_context_boost(tag, category, all_tags)` - コンテキストブースト計算（一般的すぎる単語除外）
- `has_negation(tag)` - 否定語チェック（一般的すぎる単語除外）
- `has_modifier(tag)` - 修飾語チェック（一般的すぎる単語除外）
- `extract_color_keywords(tag)` - 色キーワード抽出（一般的すぎる単語除外）
- `extract_style_keywords(tag)` - スタイルキーワード抽出（一般的すぎる単語除外）
- `get_synonyms(word)` - 同義語取得
- `has_negation(tag)` - 否定語チェック
- `has_modifier(tag)` - 修飾語チェック
- `extract_color_keywords(tag)` - 色キーワード抽出
- `extract_style_keywords(tag)` - スタイルキーワード抽出

## 9. AI予測機能（modules/ai_predictor.py）

### クラス
- `TagUsageTracker` - タグ使用追跡
- `DynamicWeightCalculator` - 動的重み計算
- `AIPredictor` - AI予測メインクラス

### 主要メソッド
- `predict_category_with_confidence(tag, context_tags, confidence_threshold)` - 信頼度付きカテゴリ予測
- `suggest_similar_tags(tag, limit)` - 類似タグ提案
- `get_tag_statistics(tag)` - タグ統計取得
- `record_prediction_result(tag, predicted_category, actual_category)` - 予測結果記録

### グローバル関数
- `predict_category_ai(tag, context_tags)` - AI予測（簡易版、一般的すぎる単語除外）
- `suggest_similar_tags_ai(tag, limit)` - 類似タグ提案（簡易版）

## 10. ユーザーカスタマイズ（modules/customization.py）

### クラス
- `UserSettings` - ユーザー設定管理
- `CustomKeywordManager` - カスタムキーワード管理
- `CustomRuleManager` - カスタムルール管理
- `CustomizationManager` - 統合カスタマイズ管理

### 主要メソッド
- `add_custom_keyword(category, keyword, weight)` - カスタムキーワード追加（一般的すぎる単語拒否）
- `remove_custom_keyword(category, keyword)` - カスタムキーワード削除
- `add_custom_rule(rule_type, condition, action, priority)` - カスタムルール追加（一般的すぎる単語拒否）
- `remove_custom_rule(rule_id)` - カスタムルール削除
- `apply_custom_rules_to_score(tag, category, base_score, context_tags)` - カスタムルール適用（一般的すぎる単語除外）

### グローバル関数
- `get_customized_category_keywords(base_keywords)` - カスタマイズ済みキーワード取得（一般的すぎる単語除外）
- `apply_custom_rules(tag, category, base_score, context_tags)` - カスタムルール適用（簡易版、一般的すぎる単語除外）

## 11. 定数定義（modules/constants.py）

### 後方互換性のための関数
- `safe_load_json(filepath)` - 安全なJSON読み込み
- `auto_assign_category_context_aware_pure(tag, category_keywords, category_priorities, all_tags)` - コンテキスト認識版自動割り当て（一般的すぎる単語除外）
- `auto_assign_category_advanced_pure(tag, category_keywords, category_priorities)` - 高度版自動割り当て（一般的すぎる単語除外）
- `auto_assign_category_pure(tag, category_keywords, category_priorities)` - 基本版自動割り当て（一般的すぎる単語除外）
- `auto_assign_category(tag)` - 既存互換用エイリアス

## 12. 一般的すぎる単語管理（modules/common_words.py）

### 定数
- `COMMON_WORDS` - 一般的すぎる単語のセット（"none", "no", "the", "a", "an", "and", "or", "but", "in", "on", "at", "to", "for", "of", "with", "by", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did", "will", "would", "could", "should", "may", "might", "can", "must", "shall", "this", "that", "these", "those", "i", "you", "he", "she", "it", "we", "they", "me", "him", "her", "us", "them", "my", "your", "his", "her", "its", "our", "their", "mine", "yours", "hers", "ours", "theirs", "all", "any", "both", "each", "few", "more", "most", "other", "some", "such", "no", "nor", "only", "own", "same", "so", "than", "too", "very", "s", "t", "can", "will", "just", "don", "should", "now", "d", "ll", "m", "o", "re", "ve", "y", "ain", "aren", "couldn", "didn", "doesn", "hadn", "hasn", "haven", "isn", "ma", "mightn", "mustn", "needn", "shan", "shouldn", "wasn", "weren", "won", "wouldn"）

## 📁 重要なファイルパス一覧

### 設定ファイル
- `resources/config/categories.json` - カテゴリキーワード
- `resources/config/ai_settings.json` - AI予測設定
- `resources/config/translated_tags.json` - 翻訳タグ
- `resources/config/negative_tags.json` - ネガティブタグ

### データファイル
- `resources/tags.db` - メインデータベース
- `resources/backups/learning_data.json` - AI学習データ
- `resources/backups/tag_usage_patterns.json` - タグ使用パターン
- `resources/backups/user_settings.json` - ユーザー設定
- `resources/backups/custom_keywords.json` - カスタムキーワード
- `resources/backups/custom_rules.json` - カスタムルール

### テーマ・設定
- `theme_settings.json` - テーマ設定（ルート）
- `mypy.ini` - MyPy設定
- `pytest.ini` - Pytest設定

## ⚠️ 重要な注意事項

### モジュール依存関係
- `modules/constants.py` は後方互換性のため残す
- 新しい機能は専用モジュールに実装
- 循環インポートを避ける

### AI予測機能
- 信頼度70%未満の場合はコンテキスト認識にフォールバック
- 学習データは自動的に蓄積される
- エラー時は従来の方法でフォールバック
- 一般的すぎる単語（"none", "no", "the", "a", "an", "and", "or", "but", "in", "on", "at", "to", "for", "of", "with", "by", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did", "will", "would", "could", "should", "may", "might", "can", "must", "shall", "this", "that", "these", "those", "i", "you", "he", "she", "it", "we", "they", "me", "him", "her", "us", "them", "my", "your", "his", "her", "its", "our", "their", "mine", "yours", "hers", "ours", "theirs", "all", "any", "both", "each", "few", "more", "most", "other", "some", "such", "no", "nor", "only", "own", "same", "so", "than", "too", "very", "s", "t", "can", "will", "just", "don", "should", "now", "d", "ll", "m", "o", "re", "ve", "y", "ain", "aren", "couldn", "didn", "doesn", "hadn", "hasn", "haven", "isn", "ma", "mightn", "mustn", "needn", "shan", "shouldn", "wasn", "weren", "won", "wouldn"）は自動的に"未分類"として扱う

### ユーザーカスタマイズ機能
- カスタムキーワードはカテゴリ別に管理
- カスタムルールは条件とアクションで定義
- 設定は自動的に保存される
- 一般的すぎる単語はカスタムキーワード・ルールとして追加できない

### 変更時のチェックリスト
- [ ] 型チェック（mypy）の実行
- [ ] テストの実行
- [ ] 技術仕様書の更新
- [ ] ToDoリストの更新
- [ ] モジュール依存関係の確認

### テスト更新の必須ルール
- **新機能追加時**: 必ず新機能の単体テストと統合テストを作成
- **機能削除時**: 関連するテストを削除または無効化
- **機能変更時**: 既存テストを更新して新しい動作に対応
- **テストファイル**: `tests/` ディレクトリ内の全ファイルを確認
- **テスト実行**: 変更後は必ず `pytest` で全テストを実行
- **テスト失敗時**: テストの修正を最優先で対応
- **テーマ設定テスト**: 実際の設定ファイルを変更するテストは必ず一時的なファイルを使用し、テスト後に復元
- **ファイル操作テスト**: 実際のファイルを変更するテストは必ずバックアップと復元を実装
- **モンキーパッチ使用時**: テスト後に必ず元の状態に復元（`monkeypatch.undo()`を使用）

### テスト環境分離の重要事項
- **テーマ設定ファイル**: `resources/config/theme_settings.json`
  - テストでは実際のファイルを変更せず、一時的なファイルを使用
  - テスト用のTHEME_FILEパスをモンキーパッチで変更
  - finallyブロックで確実に元の設定を復元
- **データベースファイル**: テストでは独立した一時的なデータベースファイルを使用
- **設定ファイル**: テストで変更する設定ファイルは必ずバックアップと復元を実装

### モジュール分け時
- [ ] 新しいモジュールの作成
- [ ] 既存コードの移動
- [ ] インポート文の更新
- [ ] 後方互換性の確保
- [ ] 型チェックの確認

## 📝 更新履歴

### 2025/07/27 - 一般的すぎる単語の除外機能実装
- ✅ `modules/common_words.py`の新規作成
- ✅ 一般的すぎる単語（"none", "no", "the", "a", "an", "and", "or", "but", "in", "on", "at", "to", "for", "of", "with", "by", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did", "will", "would", "could", "should", "may", "might", "can", "must", "shall", "this", "that", "these", "those", "i", "you", "he", "she", "it", "we", "they", "me", "him", "her", "us", "them", "my", "your", "his", "her", "its", "our", "their", "mine", "yours", "hers", "ours", "theirs", "all", "any", "both", "each", "few", "more", "most", "other", "some", "such", "no", "nor", "only", "own", "same", "so", "than", "too", "very", "s", "t", "can", "will", "just", "don", "should", "now", "d", "ll", "m", "o", "re", "ve", "y", "ain", "aren", "couldn", "didn", "doesn", "hadn", "hasn", "haven", "isn", "ma", "mightn", "mustn", "needn", "shan", "shouldn", "wasn", "weren", "won", "wouldn"）の除外機能を全モジュールに実装
- ✅ 循環インポート問題の解決
- ✅ テストの修正と全テスト通過確認
- ✅ 技術仕様書の更新完了

### 2025/07/27 - AI予測・カスタマイズ機能統合
- ✅ AI予測機能のUI統合完了
- ✅ ユーザーカスタマイズ機能のUI統合完了
- ✅ カテゴリ自動割り当てのAI予測統合完了
- ✅ 詳細結果表示のAI予測対応完了
- ✅ 型チェックエラーの修正完了
- ✅ 技術仕様書の更新完了

### 2025/07/27 - モジュール分け・高度機能実装
- ✅ モジュール分け完了（config, category_manager, context_analyzer, ai_predictor, customization）
- ✅ 機械学習ベースの動的重み付けシステム実装
- ✅ AI予測機能実装
- ✅ ユーザーカスタマイズ機能実装
- ✅ 後方互換性の確保

### 2025/07/27 - コンテキスト認識機能実装
- ✅ 同義語マッピング実装
- ✅ コンテキスト強化ルール実装
- ✅ 否定語・修飾語認識実装
- ✅ 詳細なコンテキスト分析実装

### 2025/07/27 - 高度なカテゴリ自動割り当て
- ✅ カテゴリ優先度システム実装
- ✅ キーワード重み付けシステム実装
- ✅ 詳細な割り当て結果表示実装

### 2025/07/27 - 未分類タグ一括整理機能
- ✅ メニューバー統合
- ✅ 非同期処理実装
- ✅ プログレス表示実装
- ✅ 詳細結果表示実装

### 2025/07/27 - 自動化システム構築
- ✅ Git pre-commitフック実装
- ✅ Pythonスクリプト実装
- ✅ バッチファイル実装
- ✅ GitHub Actions実装
- ✅ Cursor/VSCode設定実装

### 2025/07/27 - GitHub統合
- ✅ リポジトリ初期化
- ✅ リモート設定
- ✅ 初回コミット・プッシュ
- ✅ 自動化チェック統合

### 2025/07/27 - ドキュメント整備
- ✅ 技術仕様書作成
- ✅ AI参照ガイド作成
- ✅ ToDoリスト整理
- ✅ README更新
- ✅ CONTRIBUTING作成

### 2025/07/27 - UI改善・バグ修正
- ✅ タグ一覧表示修正
- ✅ カテゴリ一括変更修正
- ✅ 全カテゴリでの削除機能追加
- ✅ スクロールバー実装
- ✅ 一括編集機能削除

### 2025/07/27 - 基本機能実装
- ✅ 型アノテーション追加
- ✅ MyPy型チェック対応
- ✅ テーマ管理実装
- ✅ タグ管理実装
- ✅ ダイアログ実装 