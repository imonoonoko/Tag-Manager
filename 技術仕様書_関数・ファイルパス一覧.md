# 技術仕様書：関数・ファイルパス一覧

## 📋 概要
このドキュメントは、Tag-Manager-Nightlyプロジェクトの現在の関数定義とファイルパスを記録し、今後の変更時に不具合が発生しないようにするための技術仕様書です。

**最終更新日**: 2025/07/27  
**プロジェクトバージョン**: 最新版（重大UIバグ修正・新機能実装完了後）

---

## 🗂️ プロジェクト構造

### ルートディレクトリ
```
Tag-Manager-Nightly/
├── main.py                    # エントリーポイント
├── modules/                   # 主要モジュール
├── tests/                     # テストファイル
├── resources/                 # リソースファイル
├── logs/                      # ログファイル
├── backup/                    # バックアップファイル
├── requirements.txt           # 依存関係
├── mypy.ini                  # mypy設定
├── pytest.ini               # pytest設定
└── theme_settings.json       # テーマ設定
```

### 主要ディレクトリ詳細
```
modules/
├── __init__.py
├── ui_main.py                # メインUIロジック（1246行）
├── tag_manager.py            # データベース管理（630行）
├── dialogs.py                # ダイアログ定義（157行）
├── theme_manager.py          # テーマ管理（96行）
└── constants.py              # 定数定義（82行）

resources/
├── tags.db                   # メインデータベース
├── config/
│   ├── categories.json       # カテゴリ定義
│   ├── prompt_structure.json # プロンプト構造
│   ├── translated_tags.json  # 翻訳済みタグ
│   ├── negative_tags.json    # ネガティブタグ
│   ├── tags.json            # タグ設定
│   └── prompts.json         # プロンプト設定
└── icons/                    # アイコンファイル

tests/
├── test_ui_main_logic.py     # UIロジックテスト
├── test_ui_main_gui.py       # UI自動テスト
├── test_tag_manager.py       # データベーステスト
├── test_constants_logic.py   # 定数テスト
├── test_theme_manager_logic.py # テーマテスト
├── test_dialogs_logic.py     # ダイアログロジックテスト
├── test_dialogs_gui.py       # ダイアログGUIテスト
└── utils/                    # テストユーティリティ
```

---

## 🔧 主要クラス・関数一覧

### 1. エントリーポイント（main.py）

#### 関数
- `global_exception_hook(exctype, value, traceback)` - グローバル例外ハンドラー

#### 初期化フロー
```python
if __name__ == "__main__":
    sys.excepthook = global_exception_hook
    root = tb.Window()
    app = TagManagerApp(root)
    root.mainloop()
```

### 2. UIメインロジック（modules/ui_main.py）

#### クラス定義
```python
class ProgressDialog:
    def __init__(self, parent: Any, title: str = "処理中", message: str = "処理中です。しばらくお待ちください...") -> None
    def set_message(self, msg: str) -> None
    def close(self) -> None

class TagManagerApp:
    def __init__(self, root: Any, db_file: Optional[str] = None) -> None
    # ... 全メソッド一覧は後述

class ToolTip:
    def __init__(self, widget: Any, text: str) -> None
    def show_tip(self, event: Optional[Any] = None) -> None
    def hide_tip(self, event: Optional[Any] = None) -> None
```

#### 純粋関数（モジュールレベル）
```python
def build_category_list(category_keywords: Dict[str, List[str]]) -> List[str]
def build_category_descriptions() -> Dict[str, str]
```

#### TagManagerApp メソッド一覧
```python
# 初期化・設定関連
def load_categories(self) -> None
def load_prompt_structure_priorities(self) -> None
def load_category_descriptions(self) -> None
def setup_ui(self) -> None
def backup_db(self) -> None

# UI操作関連
def refresh_tabs(self) -> None
def show_current_tree(self) -> None
def on_category_select(self, event: Any) -> None
def on_tree_select(self, event: Any) -> None
def on_search_change(self, *args: Any) -> None
def on_closing(self) -> None

# タグ操作関連
def add_to_output(self, event: Optional[Any] = None) -> None
def insert_weighted_tags(self) -> None
def select_tag_in_tree(self, tag_to_select: str) -> None
def copy_to_clipboard(self) -> None
def clear_output(self) -> None
def copy_selected_tags(self) -> None

# タグ管理関連
def save_edit(self) -> None
def clear_edit_panel(self) -> None
def toggle_favorite(self) -> None
def delete_tag(self) -> None
def bulk_category_change(self) -> None
def prompt_and_add_tags(self, is_negative: bool = False) -> None

# インポート・エクスポート関連
def import_tags_async(self) -> None
def export_tags(self, tree: Any) -> None
def export_all_tags(self) -> None

# ワーカー関数（非同期処理）
def worker_add_tags(self, tags: List[str], is_negative: bool) -> None
def worker_import_tags(self, file_path: str) -> None
def worker_import_tags_csv(self, file_path: str) -> None
def worker_thread_fetch(self, q: queue.Queue[Any], filter_text: str, category_to_fetch: str) -> None

# フィルタリング・ソート関連
def filter_tags_optimized(self, tags: List[Dict[str, Any]], filter_text: str, category: str) -> List[Dict[str, Any]]
def sort_prompt_by_priority(self, tags_data: List[Dict[str, Any]]) -> List[Dict[str, Any]]

# 重み付け関連
def update_weight(self, value: str) -> None
def update_weight_selection(self) -> None
def refresh_weight_display(self) -> None
def refresh_weight_output(self) -> None
def clear_weight_selection(self) -> None

# テーマ関連
def apply_theme(self, theme_name: str) -> None

# コンテキストメニュー関連
def setup_context_menu(self, tree: Any) -> None
def show_context_menu(self, event: Any, tree: Any) -> None
def set_category_from_menu(self, category: str) -> None

# ユーティリティ関数
def _format_output_text(self, tags_data: List[Dict[str, Any]]) -> str
def _strip_weight_from_tag(self, tag: str) -> List[str]
def _is_float(self, value: str) -> bool

# コマンド生成関数
def make_theme_menu_command(self, theme_name: str) -> Callable[[], None]
def make_set_category_command(self, c: str) -> Callable[[], None]
def make_export_tags_command(self, tree: Any) -> Callable[[], None]
def make_show_context_menu_event(self, t: Any) -> Callable[[Any], None]
def make_set_status_clear(self) -> Callable[[], None]
def make_set_progress_message(self, msg: str) -> Callable[[], None]
def make_close_progress_dialog(self) -> Callable[[], None]

# ダミー関数（未実装機能）
def dummy_undo(self) -> None
def dummy_redo(self) -> None
def dummy_paste(self) -> None
def dummy_settings(self) -> None
def dummy_tools(self) -> None
def dummy_view(self) -> None
def dummy_recent(self) -> None
def dummy_data(self) -> None
def dummy_feedback(self) -> None
def dummy_update(self) -> None

# ヘルプ・情報関連
def show_help(self) -> None
def show_about(self) -> None
def show_shortcuts(self) -> None
def show_guide_on_startup(self) -> None

# その他
def process_queue(self) -> None
def update_category_description(self) -> None
def clear_search(self) -> None
def get_search_text(self) -> str
def add_tag_for_test(self, tag: str, is_negative: bool = False, category: str = "") -> bool
```

### 3. データベース管理（modules/tag_manager.py）

#### 純粋関数（モジュールレベル）
```python
def normalize_tag(tag: str) -> str
def is_valid_tag(tag: str) -> bool
def assign_category_if_needed(tag: str, category: str, auto_assign_func: Callable[[str], str]) -> str
def google_translate_en_to_ja(text: str) -> str
def is_valid_json_file_path(file_path: str) -> bool
def is_writable_path(file_path: str) -> bool
def is_valid_category(category: str) -> bool
```

#### TagManager クラス
```python
class TagManager:
    def __init__(self, db_file: str = DB_FILE, parent: Optional[tk.Tk] = None) -> None
    def _get_conn(self) -> sqlite3.Connection
    def _execute_query(self, query: str, params: Optional[Union[Tuple[Any, ...], Dict[str, Any]]] = None) -> sqlite3.Cursor
    def _init_database(self) -> None
    def _create_indexes(self, cursor: sqlite3.Cursor) -> None
    def close(self) -> None
    def __del__(self) -> None
    def invalidate_cache(self) -> None
    
    # データ取得関連
    def load_tags(self, is_negative: bool = False) -> List[Dict[str, Any]]
    def get_all_tags(self) -> List[Dict[str, Any]]
    def get_recent_tags(self) -> List[Dict[str, Any]]
    @property
    def positive_tags(self) -> List[Dict[str, Any]]
    @property
    def negative_tags(self) -> List[Dict[str, Any]]
    
    # タグ操作関連
    def save_tag(self, tag: str, jp: str, favorite: bool, category: str, is_negative: bool) -> bool
    def add_tag(self, tag: str, is_negative: bool = False, category: str = "") -> bool
    def exists_tag(self, tag: str) -> bool
    def delete_tag(self, tag: str, is_negative: bool = False) -> bool
    def toggle_favorite(self, tag: str, is_negative: bool = False) -> bool
    def set_category(self, tag: str, category: str, is_negative: bool = False) -> bool
    def update_tag(self, old_tag: str, new_tag: str, jp: str, category: str, is_negative: bool = False) -> bool
    def bulk_assign_category(self, tags: List[str], category: str, is_negative: bool = False) -> bool
    
    # 翻訳関連
    def _translate_tag(self, tag: str) -> str
    def translate_and_update_tag(self, tag: str, is_negative: bool = False) -> bool
    
    # 最近使用タグ関連
    def add_recent_tag(self, tag: str, is_negative: bool = False) -> None
    
    # インポート・エクスポート関連
    def export_tags_to_json(self, tags: List[Dict[str, Any]], file_path: str) -> bool
    def export_all_tags_to_json(self, file_path: str) -> bool
    def import_tags_from_json(self, file_path: str) -> Tuple[int, int, List[Dict[str, Any]]]
    def export_tags_to_csv(self, tags: List[Dict[str, Any]], file_path: str) -> bool
    def import_tags_from_csv(self, file_path: str) -> Tuple[int, int, List[Dict[str, Any]]]
```

### 4. ダイアログ定義（modules/dialogs.py）

#### クラス定義
```python
class CategorySelectDialog(simpledialog.Dialog):
    def __init__(self, parent: tk.Tk, categories: List[str]) -> None
    def ok(self, event: Optional[Event] = None) -> None
    def cancel(self, event: Optional[Event] = None) -> None

class BulkCategoryDialog:
    def __init__(self, parent: tk.Tk, tags: List[str]) -> None
    def ok(self) -> None
    def cancel(self) -> None

class BulkEditDialog:
    def __init__(self, parent: tk.Tk, tags: List[str]) -> None
    def show(self) -> Optional[Dict[str, Any]]  # 戻り値: 編集結果辞書
```

#### 純粋関数
```python
def get_category_choices(category_keywords: Dict[str, List[str]]) -> List[str]
def validate_bulk_category_action(action: str, to_category: str) -> bool
def safe_validate_bulk_category_action(action: str, to_category: str, logger: Optional[logging.Logger] = None) -> bool
```

### 5. テーマ管理（modules/theme_manager.py）

#### クラス定義
```python
class ThemeManager:
    def __init__(self) -> None
    def _load_theme_settings(self) -> Optional[Dict[str, Any]]
    def save_theme_settings(self, theme_name: str) -> None
    def set_theme(self, theme_name: str) -> None
    def get_available_themes(self) -> List[str]
```

#### 純粋関数
```python
def get_available_themes_pure() -> List[str]
def load_theme_settings_pure(filepath: str) -> Dict[str, Any]
def save_theme_settings_pure(filepath: str, theme_name: str) -> bool
```

### 6. 定数定義（modules/constants.py）

#### 定数
```python
POSITIVE_PROMPT_FILE = os.path.join('resources', 'config', "translated_tags.json")
NEGATIVE_PROMPT_FILE = os.path.join('resources', 'config', "negative_tags.json")
DB_FILE = os.path.join('resources', "tags.db")
THEME_FILE = "theme_settings.json"
TRANSLATING_PLACEHOLDER = "(翻訳中...)"
CATEGORY_KEYWORDS_FILE = os.path.join(os.path.dirname(__file__), '..', 'resources', 'config', 'categories.json')
```

#### 関数
```python
def load_category_keywords() -> Dict[str, List[str]]
def safe_load_json(filepath: str) -> Optional[Any]
def auto_assign_category_pure(tag: Optional[str], category_keywords: Optional[Dict[str, List[str]]], category_priorities: Optional[Dict[str, int]] = None) -> str
def auto_assign_category(tag: str) -> str  # 既存互換用エイリアス
```

---

## 📁 重要なファイルパス一覧

### データベースファイル
```python
# メインデータベース（絶対パス）
db_path = os.path.join(os.path.dirname(__file__), '..', 'resources', 'tags.db')

# 定数定義での相対パス
DB_FILE = os.path.join('resources', "tags.db")
```

### 設定ファイル
```python
# カテゴリ定義
categories_file = os.path.join('resources', 'config', 'categories.json')

# プロンプト構造
prompt_structure_file = os.path.join('resources', 'config', 'prompt_structure.json')

# 翻訳済みタグ
translated_tags_file = os.path.join('resources', 'config', "translated_tags.json")

# ネガティブタグ
negative_tags_file = os.path.join('resources', 'config', "negative_tags.json")

# テーマ設定
theme_file = "theme_settings.json"  # ルートディレクトリ
```

### ログファイル
```python
log_file = 'logs/app.log'
```

### バックアップファイル
```python
# バックアップディレクトリ
backup_dir = 'backup/'

# バックアップファイル命名規則
backup_filename = f"tags_backup_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.db"
```

---

## ⚠️ 重要な注意事項

### 1. データベースパス
- **絶対パス使用**: `TagManagerApp.__init__`では絶対パスを使用
- **相対パス使用**: `constants.py`では相対パスを使用
- **変更時注意**: パス変更時は両方の定義を確認

### 2. 初期化順序
```python
# TagManagerApp.__init__での初期化順序
1. self.theme_manager = ThemeManager()
2. self.tag_manager = TagManager(db_file=db_path, parent=self.root)
3. self.tag_manager.invalidate_cache()
4. self.load_categories()
5. self.load_prompt_structure_priorities()
6. self.load_category_descriptions()
7. self.setup_ui()
8. self.process_queue()
9. self.refresh_tabs()  # 初期データ読み込み
10. self.show_guide_on_startup()
```

### 3. 非同期処理
- `worker_*`関数は別スレッドで実行
- `process_queue()`でメインスレッドに結果を返す
- UI更新は必ずメインスレッドで実行

### 4. キャッシュ管理
- `TagManager`のキャッシュは`invalidate_cache()`で無効化
- データ変更後は必ずキャッシュを無効化

### 5. 例外処理
- データベース操作は`try-except`で囲む
- UI操作の例外は`messagebox.showerror`で表示
- ログ出力は`logging`を使用

---

## 🔄 変更時のチェックリスト

### 関数名変更時
- [ ] 関数定義箇所を更新
- [ ] 呼び出し箇所を全て検索・更新
- [ ] テストファイルの関数名も更新
- [ ] ドキュメントを更新

### ファイルパス変更時
- [ ] `constants.py`の定数を更新
- [ ] `ui_main.py`の絶対パスを更新
- [ ] テストファイルのパスも更新
- [ ] 実際のファイル・ディレクトリ構造を確認

### クラス構造変更時
- [ ] `__init__`メソッドの引数を確認
- [ ] 継承関係を確認
- [ ] メソッドの依存関係を確認
- [ ] テストケースを更新

### データベーススキーマ変更時
- [ ] `_init_database()`メソッドを更新
- [ ] マイグレーション処理を追加
- [ ] 既存データの互換性を確認
- [ ] バックアップを取得

---

## 📝 更新履歴

- **2025/07/27**: 初版作成（重大UIバグ修正・新機能実装完了後）
- 関数一覧、ファイルパス、注意事項を記録
- 変更時のチェックリストを追加

---

**注意**: このドキュメントは現在の実装を正確に反映しています。コード変更時は必ずこのドキュメントも更新してください。 